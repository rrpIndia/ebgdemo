<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- ================= PAGE LAYOUT CSS ================= -->
<style>
body {
  margin: 0;
}

.hd {
  filter: drop-shadow(2px 3px 2px rgb(0 0 0 / 0.4));
}

.evm {
  display: flex;
  flex-direction: column; /* mobile */
  align-items: center;
  gap: 16px;
}

.svg-vvpat-wrapper {
  margin-top: 24px;
  display: flex;
  justify-content: center;
}

.svg-vvpat {
  width: 320px;
  max-width: 90vw;
  outline:2px solid lime;
}

.svg-ballot-unit-wrapper {
  display: flex;
  justify-content: center;
}

.svg-ballot-unit {
  outline:2px solid lime;
  max-width: 95vw;
  width: 320px;
}

.wire-layer {
  position: absolute;
  width: 100%;
  height: 100%;
  pointer-events: none;
  opacity: 0;
}

#wire {
  fill: none;
  stroke: #f4c400;
  stroke-width: 8;
  stroke-linecap: round;
}
</style>
</head>

<body>

<div class="evm">

<!-- ================= WIRE ================= -->
<svg class="wire-layer" viewBox="0 0 400 600">
  <path id="wire"
    d="M 310 180
       C 310 180, 350 180, 355 180
       C 360 210, 360 240, 355 260
       C 330 270, 260 250, 200 260
       L 200 318"/>
</svg>

<!-- ================= VVPAT ================= -->
<div class="svg-vvpat-wrapper">
<svg xmlns="http://www.w3.org/2000/svg"
     viewBox="0 0 600 720"
     class="svg-vvpat">

<defs>
<g id="vvpat-slip">
  <rect x="0" y="0"
        width="148" height="98"
        fill="#fdfdfd"
  	stroke="#c4c4c4"
	rx="4"/>
  <!-- uses js to show slip-->
  <text x="74" y="49"
        text-anchor="middle"
        dominant-baseline="middle"
        font-size="42"></text>
</g>
</defs>

<g transform="translate(130,40)">

<!-- Hinges -->
  <rect x="-8" y="126" width="8" height="48" rx="2" fill="#999"/>
  <circle cx="-3" cy="150" r="3" fill="#666"/>

  <rect x="-8" y="376" width="8" height="48" rx="2" fill="#999"/>
  <circle cx="-3" cy="400" r="3" fill="#666"/>

<!-- Fixed VVPAT inner base interior of vvpat) (always visible) -->
<rect x="0" y="0"
      width="340" height="550"
      rx="18"
      fill="#b0b0b0"
      stroke="#9a9a9a"/>
<rect x="2" y="2"
      width="336" height="546"
      rx="17"
      fill="none"
      stroke="#8c8c8c"
      stroke-width="3"/>

<g id="vote-1-placeholder"></g>
<g id="vote-2-placeholder"></g>
<g id="vote-3-placeholder"></g>
<g id="vote-4-placeholder"></g>
<!--=======start of lid========-->
<g id="vvpat-top">
  <rect x="0" y="0" 
	width="340"
	height="550"
        rx="18"
/>

  <!--black glass-->
  <rect x="95" y="30"
	width="150" 
	height="100"
        fill="black"
	rx="4"/>

  <!--VVPAT FOOTER FOR TEXT-->
  <rect x="15" y="475" rx="8" width="310" height="60" class="vvpat-footer"/>

  <text x="170" y="505" text-anchor="middle" dominant-baseline="middle" class="vvpat-footer-text"> MOCK VVPAT </text>
</g>
<!--========end of lid========-->

<!-- VVPAT Slip -->
<g id="vvpat-slip-placeholder"></g>
</g>

</svg>
</div>

<button onclick="toggleVVPAT()">Open / Close VVPAT</button>

<style>
#vvpat-top {
  fill: #e6e6e6;
  stroke: #aaa;
  transform-origin: 0% 50%;
  transform-box: fill-box;
  transition: transform 0.9s ease;
  filter: drop-shadow(2px 3px 2px rgb(0 0 0 / 0.4));
}

#vvpat-top.open {
  transform: perspective(800px) rotateY(-120deg);
}

.vvpat-footer {
  fill: lightgray;
  stroke: darkgray;
  stroke-width: 3px;
}

.vvpat-footer-text {
  fill: #222;
  stroke: #aaa;
  stroke-width: 1.2;
  paint-order: stroke fill;
  font-size: 24px;
  font-weight: bold;
  letter-spacing: 0.5px;
  filter: drop-shadow(2px 3px 2px rgb(0 0 0 / 0.4));
}

#vvpat-inner-face {
  transition: opacity 0.4s ease;
  opacity: 0;
}

#vvpat-top.open #vvpat-inner-face {
  opacity: 1;
}

#vvpat-inner-shadow {
  transition: opacity 0.5s ease;
  opacity: 0;
}
#vvpat-top.open ~ #vvpat-slip {
  filter: drop-shadow(0 4px 6px rgba(0,0,0,0.25));
}

use {
  transition: transform 0.8s ease-in-out;
}
</style>


<!-- ================= BALLOT UNIT ================= -->
<div class="svg-ballot-unit-wrapper">
<svg xmlns="http://www.w3.org/2000/svg"
     viewBox="0 0 600 720"
     class="svg-ballot-unit"
     >

<style>

.bu-body {
  fill: gainsboro;
  stroke: #b5b5b5;
  stroke-width: 2;
  filter: drop-shadow(3px 5px 2px rgb(0 0 0 / 0.4));
}

.bu-header {
  fill: lightgray;
  stroke: darkgray;
  stroke-width: 3px;

}

.bu-header-text {
  fill: #222;
  stroke: #aaa;
  stroke-width: 1.2;
  paint-order: stroke fill;
  font-size: 22px;
  font-weight: bold;
  letter-spacing: 0.5px;
  filter: drop-shadow(2px 3px 2px rgb(0 0 0 / 0.4));
}

.bu-name-panel {
  fill: white;
  stroke: #ccc;
}

.bu-button {
  fill: #cfcfcf;
  stroke: #222;
  stroke-width: 1.5px;
  cursor: pointer;
  filter: drop-shadow(2px 3px 2px rgb(0 0 0 / 0.4));
}


.bu-button.pressed {
  filter: drop-shadow(1px 2px 1px rgb(0 0 0 / 0.25));
  fill: #c4c4c4;
}

.led {
  fill: dimgray;
}

.led.on {
  fill: green;
  filter: drop-shadow(0 0 6px #00ff00);
}
</style>

<g transform="translate(130,10)">
  <rect x="0" y="0" rx="18" width="340" height="550" class="bu-body"/>

  <rect x="10" y="10" rx="8"   width="320" height="60" class="bu-header"/>

  <!-- SVG has no parent-child layout.
       Center must be calculated manually -->
  <text x="170" y="40"
        text-anchor="middle"
        dominant-baseline="middle"
        class="bu-header-text">
	MOCK VOTING MACHINE
  </text>

  <g transform="translate(0,100)">
    <g>
      <rect x="20" y="0" width="220" height="44"
            class="bu-name-panel"/>
      <text x="30" y="28" font-size="24" font-weight="bold">
Apple üçé
      </text>
      <circle id="led-1" cx="250" cy="22" r="6" class="led"/>
      <circle id="led-2" cx="250" cy="82" r="6" class="led"/>
      
      <rect x="270" y="4" width="60" height="36" rx="6"
            class="bu-button"
            onclick="vote(this, 1)"/>
      <rect x="270" y="64" width="60" height="36" rx="6"
            class="bu-button"
            onclick="vote(this, 2)"/>
    </g>

    <g transform="translate(0,60)">
      <rect x="20" y="0" width="220" height="44"
            class="bu-name-panel"/>
      <text x="30" y="28" font-size="24" font-weight="bold">
Banana üçå
      </text>

    </g>
  </g>
</g>
</svg>
</div>
<div id="debug" style="
  position: fixed;
  bottom: 8px;
  left: 8px;
  font-size: 14px;
  color: #333;
"></div>

</div>

<!-- ================= APPLICATION LOGIC ================= -->
<script>
let previewSlip = null;        // unresolved slip at preview
let lastVoteSymbol = null;    // üçé / üçå
const winner = "üçå";
let votingClosedNotified = false;
let artificialLightOn = false;
let vvpatOpen = false;
let winnerEmittedForRun = false;
const voteLog = new Map();    // ONLY finalized slips

let isLocked = false;
let unlockTimer = null;

const PREVIEW_POS = { x: 96, y: 31 };

const STORAGE_POSITIONS = [
  { x: 14,  y: 324 }, // vote-1
  { x: 178, y: 324 },  // vote-2
  { x: 14,  y: 438 }, // vote-3
  { x: 178, y: 438 } // vote-4
  ];

function createSlip(symbol) {
  const template = document.getElementById("vvpat-slip");
  const slip = template.cloneNode(true);
  slip.removeAttribute("id");
  slip.querySelector("text").textContent = symbol;
  return slip;
}

function placePreview(slip) {
  slip.setAttribute(
    "transform",
    `translate(${PREVIEW_POS.x} ${PREVIEW_POS.y})`
  );
  document.getElementById("vvpat-slip-placeholder").appendChild(slip);
}



function getLastVote() {
  if (voteLog.size === 0) return null;
  return Array.from(voteLog.values()).at(-1);
}
function acquireLock() {
  if (isLocked) return false;
  isLocked = true;
  return true;
}

function releaseLock() {
  isLocked = false;
  console.log('Machine unlocked');
}

function tempLED(n) {
  document.querySelectorAll('.led')
    //remove on from class="led on"
    .forEach(l => l.classList.remove('on'));

  const led = document.getElementById('led-' + n);
  if (!led) return;

  led.classList.add('on');

  // turn OFF after 7 seconds
  setTimeout(() => {
    led.classList.remove('on');
  }, 7000);
}

let lightTimer = null;

function startArtificialLight(onExpire) {
  artificialLightOn = true;
  updateSlipVisibility();

  if (lightTimer) clearTimeout(lightTimer);
  lightTimer = setTimeout(() => {
    artificialLightOn = false;
    if (onExpire) onExpire();
    updateSlipVisibility();
  }, 7000);
}

function updateSlipVisibility() {
  const stored = Array.from(voteLog.values());
  const all = previewSlip ? [...stored, previewSlip] : stored;

  all.forEach(slip => {
    if (vvpatOpen) {
      slip.setAttribute("opacity", "1");
    } else if (artificialLightOn) {
      slip.setAttribute("opacity", slip === previewSlip ? "1" : "0");
    } else {
      slip.setAttribute("opacity", "0");
    }
  });
}

function showVVPAT(buttonNumber) {
  const symbol = (buttonNumber === 1) ? "üçé" : "üçå";

  // CASE 1: first vote OR different vote
  if (lastVoteSymbol !== symbol) {

  winnerEmittedForRun = false; // üîë RESET HERE

    // resolve old preview (loser waits for vote)
    if (previewSlip) {
      finalizeSlip(previewSlip);
      previewSlip = null;
    }

    previewSlip = createSlip(symbol);
    placePreview(previewSlip);
    lastVoteSymbol = symbol;

    startArtificialLight(() => {
      // ONLY winner auto-resolves
      if (
        previewSlip &&
        previewSlip.querySelector("text").textContent === winner
      ) {
        finalizeSlip(previewSlip);
        previewSlip = null;
      }
    });

    return;
  }
// CASE 2: same vote again
startArtificialLight(() => {

  // finalize preview if present
  if (previewSlip) {
    finalizeSlip(previewSlip);
    previewSlip = null;
  }

  // emit winner only once
  if (!winnerEmittedForRun) {
    const winnerSlip = createSlip(winner);
    finalizeSlip(winnerSlip);
    winnerEmittedForRun = true;
  }

  // üîë END THE RUN
  lastVoteSymbol = null;
  winnerEmittedForRun = false;
});
}

function votingEnded() {
  return voteLog.size >= 4;
}

function vote(el, n) {
  if (votingEnded()) {
    if (!votingClosedNotified) {
      alert("Voting has ended.\nPlease see the results.");
      votingClosedNotified = true;
    }
    return;
  }

  if (!acquireLock()) return;

  if (unlockTimer) clearTimeout(unlockTimer);

  el.classList.add("pressed");
  setTimeout(() => el.classList.remove("pressed"), 1500);

  tempLED(n);
  showVVPAT(n);

  unlockTimer = setTimeout(releaseLock, 7000);
}

function toggleVVPAT() {
  const top = document.getElementById('vvpat-top');

  vvpatOpen = !vvpatOpen;
  top.classList.toggle('open', vvpatOpen);
    updateSlipVisibility();


}

function finalizeSlip(slip) {
  voteLog.set(`vote-${voteLog.size + 1}`, slip);
  layoutStorage();
}

function layoutStorage() {
  const slips = Array.from(voteLog.values());

  slips.forEach((slip, index) => {
    const pos = STORAGE_POSITIONS[index];
    if (!pos) return;

    slip.setAttribute(
      "transform",
      `translate(${pos.x} ${pos.y})`
    );

    document
      .getElementById(`vote-${index + 1}-placeholder`)
      .appendChild(slip);
  });
}

</script>

</body>
</html>
